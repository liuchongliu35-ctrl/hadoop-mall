# 秒杀活动管理模块功能说明

## 一、模块概述

秒杀活动管理模块是秒杀系统的核心业务模块之一，负责秒杀活动的创建、更新、查询和状态管理。该模块采用经典的三层架构设计：Controller层负责接收HTTP请求并进行权限校验，Service层实现核心业务逻辑，Mapper层负责数据库操作。

## 二、技术架构

- **Controller层**：`SeckillActivityController` - RESTful API接口层
- **Service层**：`SeckillActivityService` 接口及 `SeckillActivityServiceImpl` 实现类
- **Mapper层**：`SeckillActivityMapper` 接口及对应的MyBatis XML映射文件
- **数据模型**：`SeckillActivity`（实体类）、`SeckillActivityDTO`（数据传输对象）、`SeckillActivityVO`（视图对象）

## 三、核心功能详细说明

### 功能1：新增秒杀活动

#### 1.1 Controller层代码

```39:57:src/main/java/com/seckill/controller/SeckillActivityController.java
@PostMapping
@Operation(summary = "新增秒杀活动")
public Result<Void> saveActivity(@Valid @RequestBody SeckillActivityDTO activityDTO, 
                                HttpServletRequest request) {
    // 检查权限 - 只有管理员可以创建活动
    String token = request.getHeader("Authorization");
    if (token != null && token.startsWith("Bearer ")) {
        token = token.substring(7);
        Integer role = jwtUtil.getRole(token);
        if (!Integer.valueOf(1).equals(role)) { // 1-管理员
            return Result.error(403, "无权限操作");
        }
    } else {
        return Result.error(401, "请先登录");
    }
    
    activityService.saveActivity(activityDTO);
    return Result.success();
}
```

**业务逻辑说明**：
- 接口路径：`POST /api/seckill/activity`
- 权限控制：从请求头中提取JWT token，验证用户角色是否为管理员（role=1）
- 参数校验：使用`@Valid`注解对DTO进行JSR-303验证
- 调用Service层方法完成业务处理

#### 1.2 Service层代码

```38:74:src/main/java/com/seckill/service/impl/SeckillActivityServiceImpl.java
@Override
@Transactional
public void saveActivity(SeckillActivityDTO activityDTO) {
    // 参数校验
    validateActivityParam(activityDTO);
    
    // 检查商品是否存在
    Product product = productMapper.selectById(activityDTO.getProductId());
    if (product == null) {
        throw new BusinessException("商品不存在");
    }
    
    // 检查是否已有该商品的秒杀活动
    QueryWrapper<SeckillActivity> wrapper = new QueryWrapper<>();
    wrapper.eq("product_id", activityDTO.getProductId())
           .eq("deleted", 0)
           .ge("end_time", LocalDateTime.now());
    SeckillActivity existActivity = activityMapper.selectOne(wrapper);
    if (existActivity != null) {
        throw new BusinessException("该商品已有进行中或未开始的秒杀活动");
    }
    
    // 创建秒杀活动
    SeckillActivity activity = new SeckillActivity();
    BeanUtils.copyProperties(activityDTO, activity);
    
    // 设置活动状态
    LocalDateTime now = LocalDateTime.now();
    if (activityDTO.getStartTime().isBefore(now)) {
        activity.setStatus(ActivityStatusEnum.IN_PROGRESS.getCode());
    } else {
        activity.setStatus(ActivityStatusEnum.NOT_STARTED.getCode());
    }
    
    activityMapper.insert(activity);
    log.info("创建秒杀活动成功：{}", activity.getId());
}
```

**业务逻辑说明**：
1. **参数校验**：调用`validateActivityParam`方法对活动参数进行完整性校验，包括活动名称、商品ID、秒杀价格、库存、时间等字段
2. **商品存在性检查**：通过商品ID查询商品表，确保关联的商品存在
3. **活动冲突检查**：查询该商品是否已有未结束的秒杀活动（结束时间大于当前时间），避免同一商品同时存在多个活动
4. **状态自动设置**：根据活动开始时间与当前时间的关系，自动设置活动状态（未开始/进行中）
5. **数据持久化**：使用MyBatis-Plus的`insert`方法将活动信息保存到数据库
6. **事务管理**：使用`@Transactional`注解确保数据一致性

#### 1.3 Mapper层代码

Mapper层使用MyBatis-Plus的`BaseMapper`提供的`insert`方法，无需自定义SQL。

**SQL执行逻辑**：
- 执行`INSERT INTO t_seckill_activity`语句
- 自动填充创建时间和更新时间（通过MyBatis-Plus的字段填充策略）
- 使用逻辑删除标记（deleted=0）

---

### 功能2：修改秒杀活动

#### 2.1 Controller层代码

```59:78:src/main/java/com/seckill/controller/SeckillActivityController.java
@PutMapping("/{id}")
@Operation(summary = "修改秒杀活动")
public Result<Void> updateActivity(@Parameter(description = "活动ID") @PathVariable Long id,
                                   @Valid @RequestBody SeckillActivityDTO activityDTO,
                                   HttpServletRequest request) {
    // 检查权限 - 只有管理员可以修改活动
    String token = request.getHeader("Authorization");
    if (token != null && token.startsWith("Bearer ")) {
        token = token.substring(7);
        Integer role = jwtUtil.getRole(token);
        if (!Integer.valueOf(1).equals(role)) { // 1-管理员
            return Result.error(403, "无权限操作");
        }
    } else {
        return Result.error(401, "请先登录");
    }
    
    activityService.updateActivity(id, activityDTO);
    return Result.success();
}
```

**业务逻辑说明**：
- 接口路径：`PUT /api/seckill/activity/{id}`
- 路径参数：活动ID
- 权限控制：同样需要管理员权限
- 调用Service层更新方法

#### 2.2 Service层代码

```76:121:src/main/java/com/seckill/service/impl/SeckillActivityServiceImpl.java
@Override
@Transactional
public void updateActivity(Long id, SeckillActivityDTO activityDTO) {
    // 参数校验
    validateActivityParam(activityDTO);
    
    // 检查活动是否存在
    SeckillActivity activity = activityMapper.selectById(id);
    if (activity == null) {
        throw new BusinessException("秒杀活动不存在");
    }
    
    // 检查商品是否存在
    Product product = productMapper.selectById(activityDTO.getProductId());
    if (product == null) {
        throw new BusinessException("商品不存在");
    }
    
    // 如果修改了商品，需要检查是否冲突
    if (!activity.getProductId().equals(activityDTO.getProductId())) {
        QueryWrapper<SeckillActivity> wrapper = new QueryWrapper<>();
        wrapper.eq("product_id", activityDTO.getProductId())
               .eq("deleted", 0)
               .ne("id", id)
               .ge("end_time", LocalDateTime.now());
        SeckillActivity existActivity = activityMapper.selectOne(wrapper);
        if (existActivity != null) {
            throw new BusinessException("该商品已有进行中或未开始的秒杀活动");
        }
    }
    
    // 更新活动信息
    BeanUtils.copyProperties(activityDTO, activity);
    activity.setId(id);
    
    // 如果是进行中的活动，需要重新判断状态
    if (activity.getStatus().equals(ActivityStatusEnum.IN_PROGRESS.getCode())) {
        LocalDateTime now = LocalDateTime.now();
        if (activity.getEndTime().isBefore(now)) {
            activity.setStatus(ActivityStatusEnum.ENDED.getCode());
        }
    }
    
    activityMapper.updateById(activity);
    log.info("更新秒杀活动成功：{}", id);
}
```

**业务逻辑说明**：
1. **参数校验**：对更新参数进行完整性校验
2. **活动存在性检查**：根据ID查询活动，确保活动存在
3. **商品存在性检查**：验证新关联的商品是否存在
4. **商品冲突检查**：如果修改了关联商品，检查新商品是否已有未结束的活动（排除当前活动）
5. **状态智能更新**：如果活动正在进行中，检查结束时间，如果已过期则自动更新为已结束状态
6. **数据更新**：使用`BeanUtils.copyProperties`将DTO属性复制到实体对象，然后更新数据库

#### 2.3 Mapper层代码

使用MyBatis-Plus的`updateById`方法，根据主键更新记录。

**SQL执行逻辑**：
- 执行`UPDATE t_seckill_activity SET ... WHERE id = ?`
- 自动更新`update_time`字段

---

### 功能3：分页查询秒杀活动列表

#### 3.1 Controller层代码

```80:95:src/main/java/com/seckill/controller/SeckillActivityController.java
@GetMapping("/list")
@Operation(summary = "分页查询秒杀活动")
public Result<PageResult<SeckillActivityVO>> getActivityList(
        @Parameter(description = "页码") @RequestParam(defaultValue = "1") Integer pageNum,
        @Parameter(description = "页大小") @RequestParam(defaultValue = "10") Integer pageSize,
        @Parameter(description = "活动状态") @RequestParam(required = false) Integer status) {
    
    PageQuery pageQuery = new PageQuery();
    pageQuery.setPageNum(pageNum);
    pageQuery.setPageSize(pageSize);
    IPage<SeckillActivityVO> page = activityService.getActivityList(pageQuery, status);
    
    PageResult<SeckillActivityVO> pageResult = PageResult.of(page.getTotal(), page.getRecords());
    
    return Result.success(pageResult);
}
```

**业务逻辑说明**：
- 接口路径：`GET /api/seckill/activity/list`
- 查询参数：页码（默认1）、页大小（默认10）、活动状态（可选）
- 返回分页结果，包含总记录数和当前页数据

#### 3.2 Service层代码

```168:197:src/main/java/com/seckill/service/impl/SeckillActivityServiceImpl.java
@Override
public IPage<SeckillActivityVO> getActivityList(PageQuery pageQuery, Integer status) {
    // 分页查询活动
    Page<SeckillActivity> page = new Page<>(pageQuery.getPageNum(), pageQuery.getPageSize());
    IPage<SeckillActivity> activityPage = activityMapper.selectActivityPage(page, status);
    
    // 转换为VO
    IPage<SeckillActivityVO> voPage = new Page<>();
    BeanUtils.copyProperties(activityPage, voPage);
    
    List<SeckillActivityVO> voList = new ArrayList<>();
    for (SeckillActivity activity : activityPage.getRecords()) {
        SeckillActivityVO vo = new SeckillActivityVO();
        BeanUtils.copyProperties(activity, vo);
        
        // 查询商品信息
        Product product = productMapper.selectById(activity.getProductId());
        if (product != null) {
            vo.setProductName(product.getProductName());
            vo.setOriginalPrice(product.getPrice());
            vo.setImgUrl(product.getImgUrl());
        }
        
        vo.setStatusDesc(ActivityStatusEnum.getByCode(activity.getStatus()).getDesc());
        voList.add(vo);
    }
    
    voPage.setRecords(voList);
    return voPage;
}
```

**业务逻辑说明**：
1. **分页查询**：使用MyBatis-Plus的`Page`对象构建分页参数，调用Mapper层的`selectActivityPage`方法
2. **数据转换**：将实体对象列表转换为VO对象列表
3. **关联查询**：遍历每个活动，根据商品ID查询商品信息，填充商品名称、原价、图片等字段
4. **状态描述**：将状态码转换为状态描述文字
5. **返回结果**：组装分页结果，包含总记录数和VO列表

#### 3.3 Mapper层代码

```15:15:src/main/java/com/seckill/mapper/SeckillActivityMapper.java
IPage<SeckillActivity> selectActivityPage(Page<SeckillActivity> page, @Param("status") Integer status);
```

#### 3.4 SQL映射代码

```5:13:src/main/resources/mapper/SeckillActivityMapper.xml
<select id="selectActivityPage" resultType="com.seckill.entity.SeckillActivity">
    SELECT a.*
    FROM t_seckill_activity a
    WHERE a.deleted = 0
    <if test="status != null">
        AND a.status = #{status}
    </if>
    ORDER BY a.create_time DESC
</select>
```

**SQL逻辑说明**：
- 查询未删除的活动（deleted=0）
- 如果传入状态参数，则按状态过滤
- 按创建时间倒序排列
- 使用MyBatis-Plus的分页插件实现物理分页

---

### 功能4：根据ID查询秒杀活动详情

#### 4.1 Controller层代码

```97:102:src/main/java/com/seckill/controller/SeckillActivityController.java
@GetMapping("/{id}")
@Operation(summary = "根据ID查询秒杀活动详情")
public Result<SeckillActivityVO> getActivityById(@Parameter(description = "活动ID") @PathVariable Long id) {
    SeckillActivityVO activity = activityService.getActivityById(id);
    return Result.success(activity);
}
```

**业务逻辑说明**：
- 接口路径：`GET /api/seckill/activity/{id}`
- 路径参数：活动ID
- 返回活动详情，包含关联的商品信息

#### 4.2 Service层代码

```142:166:src/main/java/com/seckill/service/impl/SeckillActivityServiceImpl.java
@Override
public SeckillActivityVO getActivityById(Long id) {
    // 查询活动信息
    SeckillActivity activity = activityMapper.selectById(id);
    if (activity == null) {
        throw new BusinessException("秒杀活动不存在");
    }
    
    // 查询商品信息
    Product product = productMapper.selectById(activity.getProductId());
    if (product == null) {
        throw new BusinessException("关联商品不存在");
    }
    
    // 组装返回信息
    SeckillActivityVO vo = new SeckillActivityVO();
    BeanUtils.copyProperties(activity, vo);
    vo.setProductName(product.getProductName());
    vo.setProductDesc(product.getProductDesc());
    vo.setOriginalPrice(product.getPrice());
    vo.setImgUrl(product.getImgUrl());
    vo.setStatusDesc(ActivityStatusEnum.getByCode(activity.getStatus()).getDesc());
    
    return vo;
}
```

**业务逻辑说明**：
1. **活动查询**：根据ID查询活动信息，如果不存在则抛出异常
2. **商品查询**：根据活动的商品ID查询商品信息，确保商品存在
3. **数据组装**：将活动信息和商品信息组装成VO对象，包括商品名称、描述、原价、图片等
4. **状态转换**：将状态码转换为描述文字

#### 4.3 Mapper层代码

使用MyBatis-Plus的`selectById`方法，根据主键查询单条记录。

**SQL执行逻辑**：
- 执行`SELECT * FROM t_seckill_activity WHERE id = ? AND deleted = 0`

---

### 功能5：手动修改活动状态

#### 5.1 Controller层代码

```104:123:src/main/java/com/seckill/controller/SeckillActivityController.java
@PutMapping("/status/{id}")
@Operation(summary = "手动修改活动状态")
public Result<Void> updateActivityStatus(@Parameter(description = "活动ID") @PathVariable Long id,
                                         @Parameter(description = "状态") @RequestParam Integer status,
                                         HttpServletRequest request) {
    // 检查权限 - 只有管理员可以修改活动状态
    String token = request.getHeader("Authorization");
    if (token != null && token.startsWith("Bearer ")) {
        token = token.substring(7);
        Integer role = jwtUtil.getRole(token);
        if (!Integer.valueOf(1).equals(role)) { // 1-管理员
            return Result.error(403, "无权限操作");
        }
    } else {
        return Result.error(401, "请先登录");
    }
    
    activityService.updateActivityStatus(id, status);
    return Result.success();
}
```

**业务逻辑说明**：
- 接口路径：`PUT /api/seckill/activity/status/{id}`
- 路径参数：活动ID
- 查询参数：新状态值
- 需要管理员权限

#### 5.2 Service层代码

```123:140:src/main/java/com/seckill/service/impl/SeckillActivityServiceImpl.java
@Override
@Transactional
public void updateActivityStatus(Long id, Integer status) {
    // 检查活动是否存在
    SeckillActivity activity = activityMapper.selectById(id);
    if (activity == null) {
        throw new BusinessException("秒杀活动不存在");
    }
    
    // 检查状态是否有效
    if (ActivityStatusEnum.getByCode(status) == null) {
        throw new BusinessException("无效的活动状态");
    }
    
    activity.setStatus(status);
    activityMapper.updateById(activity);
    log.info("更新秒杀活动状态成功：{}, 新状态：{}", id, status);
}
```

**业务逻辑说明**：
1. **活动存在性检查**：验证活动是否存在
2. **状态有效性检查**：通过枚举类验证状态值是否合法
3. **状态更新**：更新活动状态并持久化到数据库

---

### 功能6：获取活跃的秒杀活动列表

#### 6.1 Controller层代码

```125:130:src/main/java/com/seckill/controller/SeckillActivityController.java
@GetMapping("/active")
@Operation(summary = "获取活跃的秒杀活动列表")
public Result<List<SeckillActivityVO>> getActiveActivities() {
    List<SeckillActivityVO> activities = activityService.getActiveActivities();
    return Result.success(activities);
}
```

**业务逻辑说明**：
- 接口路径：`GET /api/seckill/activity/active`
- 返回所有活跃的活动（未开始和进行中）
- 主要用于前端首页展示

#### 6.2 Service层代码

```232:262:src/main/java/com/seckill/service/impl/SeckillActivityServiceImpl.java
@Override
public List<SeckillActivityVO> getActiveActivities() {
    // 查询所有活跃的活动（进行中和未开始）
    QueryWrapper<SeckillActivity> wrapper = new QueryWrapper<>();
    wrapper.in("status", ActivityStatusEnum.NOT_STARTED.getCode(), ActivityStatusEnum.IN_PROGRESS.getCode())
           .gt("end_time", LocalDateTime.now())
           .eq("deleted", 0)
           .orderByAsc("start_time");
    
    List<SeckillActivity> activities = activityMapper.selectList(wrapper);
    
    List<SeckillActivityVO> voList = new ArrayList<>();
    for (SeckillActivity activity : activities) {
        SeckillActivityVO vo = new SeckillActivityVO();
        BeanUtils.copyProperties(activity, vo);
        
        // 查询商品信息
        Product product = productMapper.selectById(activity.getProductId());
        if (product != null) {
            vo.setProductName(product.getProductName());
            vo.setProductDesc(product.getProductDesc());
            vo.setOriginalPrice(product.getPrice());
            vo.setImgUrl(product.getImgUrl());
        }
        
        vo.setStatusDesc(ActivityStatusEnum.getByCode(activity.getStatus()).getDesc());
        voList.add(vo);
    }
    
    return voList;
}
```

**业务逻辑说明**：
1. **条件查询**：查询状态为"未开始"或"进行中"，且结束时间大于当前时间的活动
2. **排序**：按开始时间升序排列，优先显示即将开始的活动
3. **数据转换**：将实体列表转换为VO列表，并填充商品信息

---

### 功能7：自动更新活动状态（定时任务）

#### 7.1 Service层代码

```199:230:src/main/java/com/seckill/service/impl/SeckillActivityServiceImpl.java
@Override
@Transactional
public void updateActivityStatusAutomatically() {
    LocalDateTime now = LocalDateTime.now();
    
    // 更新应该开始的活动
    QueryWrapper<SeckillActivity> startWrapper = new QueryWrapper<>();
    startWrapper.eq("status", ActivityStatusEnum.NOT_STARTED.getCode())
               .le("start_time", now)
               .gt("end_time", now)
               .eq("deleted", 0);
    
    List<SeckillActivity> shouldStartActivities = activityMapper.selectList(startWrapper);
    for (SeckillActivity activity : shouldStartActivities) {
        activity.setStatus(ActivityStatusEnum.IN_PROGRESS.getCode());
        activityMapper.updateById(activity);
        log.info("自动开始秒杀活动：{}", activity.getId());
    }
    
    // 更新应该结束的活动
    QueryWrapper<SeckillActivity> endWrapper = new QueryWrapper<>();
    endWrapper.eq("status", ActivityStatusEnum.IN_PROGRESS.getCode())
             .lt("end_time", now)
             .eq("deleted", 0);
    
    List<SeckillActivity> shouldEndActivities = activityMapper.selectList(endWrapper);
    for (SeckillActivity activity : shouldEndActivities) {
        activity.setStatus(ActivityStatusEnum.ENDED.getCode());
        activityMapper.updateById(activity);
        log.info("自动结束秒杀活动：{}", activity.getId());
    }
}
```

**业务逻辑说明**：
1. **自动开始活动**：查找状态为"未开始"，但开始时间已到且未结束的活动，将其状态更新为"进行中"
2. **自动结束活动**：查找状态为"进行中"，但结束时间已到的活动，将其状态更新为"已结束"
3. **定时执行**：该方法通常由定时任务（如Spring的`@Scheduled`）定期调用，确保活动状态与时间同步

---

## 四、参数校验逻辑

### 4.1 校验方法代码

```264:303:src/main/java/com/seckill/service/impl/SeckillActivityServiceImpl.java
private void validateActivityParam(SeckillActivityDTO activityDTO) {
    if (activityDTO == null) {
        throw new BusinessException("活动信息不能为空");
    }
    
    if (!StringUtils.hasText(activityDTO.getActivityName())) {
        throw new BusinessException("活动名称不能为空");
    }
    
    if (activityDTO.getProductId() == null) {
        throw new BusinessException("商品ID不能为空");
    }
    
    if (activityDTO.getSeckillPrice() == null || activityDTO.getSeckillPrice().compareTo(java.math.BigDecimal.ZERO) <= 0) {
        throw new BusinessException("秒杀价格必须大于0");
    }
    
    if (activityDTO.getSeckillStock() == null || activityDTO.getSeckillStock() <= 0) {
        throw new BusinessException("秒杀库存必须大于0");
    }
    
    if (activityDTO.getStartTime() == null) {
        throw new BusinessException("开始时间不能为空");
    }
    
    if (activityDTO.getEndTime() == null) {
        throw new BusinessException("结束时间不能为空");
    }
    
    if (activityDTO.getStartTime().isAfter(activityDTO.getEndTime())) {
        throw new BusinessException("开始时间不能晚于结束时间");
    }
    
    if (activityDTO.getEndTime().isBefore(LocalDateTime.now())) {
        throw new BusinessException("结束时间不能早于当前时间");
    }
}
```

**校验逻辑说明**：
1. **非空校验**：活动对象、活动名称、商品ID、价格、库存、时间等字段不能为空
2. **数值校验**：秒杀价格和库存必须大于0
3. **时间逻辑校验**：开始时间不能晚于结束时间，结束时间不能早于当前时间
4. **业务规则校验**：确保活动时间设置的合理性

---

## 五、数据库设计

### 5.1 实体类结构

```9:38:src/main/java/com/seckill/entity/SeckillActivity.java
@Data
@TableName("t_seckill_activity")
public class SeckillActivity {
    
    @TableId(type = IdType.AUTO)
    private Long id;
    
    private String activityName;
    
    private Long productId;
    
    private BigDecimal seckillPrice;
    
    private Integer seckillStock;
    
    private LocalDateTime startTime;
    
    private LocalDateTime endTime;
    
    private Integer status; // 0-未开始 1-进行中 2-已结束
    
    @TableField(fill = FieldFill.INSERT)
    private LocalDateTime createTime;
    
    @TableField(fill = FieldFill.INSERT_UPDATE)
    private LocalDateTime updateTime;
    
    @TableLogic
    private Integer deleted;
}
```

**字段说明**：
- `id`：主键，自增
- `activityName`：活动名称
- `productId`：关联的商品ID
- `seckillPrice`：秒杀价格
- `seckillStock`：秒杀库存
- `startTime`：开始时间
- `endTime`：结束时间
- `status`：活动状态（0-未开始，1-进行中，2-已结束）
- `createTime`：创建时间（自动填充）
- `updateTime`：更新时间（自动填充）
- `deleted`：逻辑删除标记（0-未删除，1-已删除）

---

## 六、技术亮点

1. **权限控制**：所有修改操作都进行了管理员权限校验，使用JWT token进行身份验证
2. **事务管理**：所有写操作都使用`@Transactional`注解，确保数据一致性
3. **参数校验**：使用JSR-303注解和自定义校验方法，确保数据完整性
4. **逻辑删除**：使用MyBatis-Plus的逻辑删除功能，避免物理删除数据
5. **状态管理**：实现了手动和自动两种状态更新机制，确保活动状态准确
6. **关联查询**：在查询时自动关联商品信息，提供完整的数据展示
7. **分页查询**：使用MyBatis-Plus的分页插件，实现高效的分页查询
8. **异常处理**：统一的异常处理机制，提供友好的错误提示

---

## 七、总结

秒杀活动管理模块实现了完整的CRUD功能，包括活动的创建、更新、查询和状态管理。通过三层架构的设计，实现了代码的解耦和可维护性。通过权限控制、参数校验、事务管理等机制，确保了系统的安全性和数据一致性。该模块为秒杀系统提供了稳定的活动管理基础。



